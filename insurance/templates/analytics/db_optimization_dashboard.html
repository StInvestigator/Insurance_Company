{% extends "base.html" %}
{% load static %}

{% block title %}Оптимізація доступу до БД{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Оптимізація доступу до бази даних</h1>
    
    <div class="card mb-4">
        <div class="card-header">
            <h2>Параметри експерименту</h2>
        </div>
        <div class="card-body">
            <form id="optimizationForm" method="post">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="num_queries">Кількість запитів (100-200):</label>
                            <input type="number" class="form-control" name="num_queries" id="num_queries" value="{{ params.num_queries|default:150 }}" min="100" max="200">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="num_workers">Кількість потоків/процесів (через кому):</label>
                            <input type="text" class="form-control" name="num_workers" id="num_workers" value="{{ params.num_workers_range|join:','|default:'1,2,4,8,16' }}" placeholder="1,2,4,8,16">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="batch_sizes">Розміри пакетів (через кому):</label>
                            <input type="text" class="form-control" name="batch_sizes" id="batch_sizes" value="{{ params.batch_sizes|join:','|default:'10,25,50,100' }}" placeholder="10,25,50,100">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Тип виконання:</label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="test_what" value="thread" id="test_threads" {% if params.test_threads|default_if_none:True %}checked{% endif %}>
                                <label class="form-check-label" for="test_threads">Потоки</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="test_what" value="process" id="test_processes" {% if params.test_processes %}checked{% endif %}>
                                <label class="form-check-label" for="test_processes">Процеси</label>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="runBtn" onclick="document.getElementById('loadingIndicator').style.display = 'block';">Запустити експеримент</button>
            </form>
        </div>
    </div>
    
    <div id="loadingIndicator" class="alert alert-info" style="display: none;">
        <strong>Виконується експеримент...</strong> Це може зайняти кілька хвилин.
    </div>
    
    {% if error %}
    <div id="errorAlert" class="alert alert-danger">
        {{ error }}
    </div>
    {% endif %}
    
    {% if results %}
    <div id="resultsSection">
        <div class="card mb-4">
            <div class="card-header">
                <h2>Оптимальна конфігурація</h2>
            </div>
            <div class="card-body">
                <div id="optimalConfig">
                    {{ results.optimal_config_html|safe }}
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <div id="timeByWorkersChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <div id="heatmapChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <div id="cpuChart"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <div id="memoryChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h2>Детальні результати</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="resultsTable" border="1">
                        <thead>
                            <tr>
                                <th>Потоки/Процеси</th>
                                <th>Розмір пакету</th>
                                <th>Тип</th>
                                <th>Загальний час (с)</th>
                                <th>Середній час на запит (мс)</th>
                                <th>Успішних</th>
                                <th>Помилок</th>
                                <th>CPU (%)</th>
                                <th>Пам'ять (MB)</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            {{ results.table_html|safe }}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
{% if results %}
    Plotly.newPlot('timeByWorkersChart', {{ results.time_chart|safe }}, {
        title: 'Залежність часу виконання від кількості потоків/процесів',
        xaxis: { title: 'Кількість потоків/процесів' },
        yaxis: { title: 'Час виконання (секунди)' },
        margin: { t: 40 }
    });

    Plotly.newPlot('heatmapChart', {{ results.heatmap_chart|safe }}, {
        title: 'Теплова карта: Час виконання залежно від параметрів',
        xaxis: { title: 'Кількість потоків/процесів' },
        yaxis: { title: 'Розмір пакету' },
        margin: { t: 40 }
    });

    Plotly.newPlot('cpuChart', {{ results.cpu_chart|safe }}, {
        title: 'Використання CPU',
        xaxis: { title: 'Кількість потоків/процесів' },
        yaxis: { title: 'CPU (%)' },
        margin: { t: 40 }
    });
    
    Plotly.newPlot('memoryChart', {{ results.mem_chart|safe }}, {
        title: 'Використання пам\'яті',
        xaxis: { title: 'Кількість потоків/процесів' },
        yaxis: { title: 'Пам\'ять (MB)' },
        margin: { t: 40 }
    });
{% endif %}
</script>
{% endblock %}

