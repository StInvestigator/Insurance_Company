{% extends "base.html" %}
{% load static %}

{% block title %}Оптимізація доступу до БД{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Оптимізація доступу до бази даних</h1>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Параметри експерименту</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-3">
                        <label>Кількість запитів</label>
                        <input type="number" name="num_queries" value="150" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Потоки (через кому)</label>
                        <input type="text" name="num_workers" value="1,2,4,8,16" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Batch size (через кому)</label>
                        <input type="text" name="batch_sizes" value="10,25,50,100" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Тип виконання</label><br>
                        <input type="checkbox" name="test_threads" checked> Потоки<br>
                        <input type="checkbox" name="test_processes"> Процеси
                    </div>
                </div>
                <button class="btn btn-primary mt-3" type="submit">
                    Запустити експеримент
                </button>
            </form>
        </div>
    </div>

    {% if optimal_config %}

    <div class="card mb-4">
        <div class="card-header">
            <h5>Оптимальна конфігурація</h5>
        </div>
        <div class="card-body">
            <p><b>Workers:</b> {{ optimal_config.num_workers }}</p>
            <p><b>Batch:</b> {{ optimal_config.batch_size }}</p>
            <p><b>Тип:</b>
                {% if optimal_config.use_processes %}Процеси{% else %}Потоки{% endif %}
            </p>
            <p><b>Час:</b> {{ optimal_config.total_time|floatformat:3 }} сек</p>
        </div>
    </div>

    {{ avg_time_by_workers|json_script:"avgByWorkers" }}
    {{ all_results|json_script:"allResults" }}

    <div class="card mb-4">
        <div class="card-header">
            <h5>Час виконання vs кількість потоків</h5>
        </div>
        <div class="card-body">
            <div id="timeByWorkersChart"></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Використання CPU</h5>
        </div>
        <div class="card-body">
            <div id="cpuChart"></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Детальні результати</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Workers</th>
                    <th>Batch</th>
                    <th>Тип</th>
                    <th>Час (с)</th>
                    <th>CPU %</th>
                    <th>RAM MB</th>
                </tr>
                </thead>
                <tbody>
                {% for r in all_results %}
                <tr>
                    <td>{{ r.num_workers }}</td>
                    <td>{{ r.batch_size }}</td>
                    <td>{% if r.use_processes %}Процеси{% else %}Потоки{% endif %}</td>
                    <td>{{ r.total_time|floatformat:3 }}</td>
                    <td>{{ r.cpu_usage_percent|floatformat:2 }}</td>
                    <td>{{ r.memory_usage_mb|floatformat:2 }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endif %}
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
const avgData = JSON.parse(
    document.getElementById('avgByWorkers')?.textContent || '{}'
);

if (Object.keys(avgData).length) {
    Plotly.newPlot('timeByWorkersChart', [{
        x: Object.keys(avgData),
        y: Object.values(avgData),
        type: 'scatter',
        mode: 'lines+markers'
    }], {
        xaxis: { title: 'Кількість потоків' },
        yaxis: { title: 'Час (сек)' }
    });
}

const allResults = JSON.parse(
    document.getElementById('allResults')?.textContent || '[]'
);

if (allResults.length) {
    const cpuByWorkers = {};
    allResults.forEach(r => {
        if (!cpuByWorkers[r.num_workers]) cpuByWorkers[r.num_workers] = [];
        cpuByWorkers[r.num_workers].push(r.cpu_usage_percent);
    });

    Plotly.newPlot('cpuChart', [{
        x: Object.keys(cpuByWorkers),
        y: Object.values(cpuByWorkers).map(
            v => v.reduce((a,b)=>a+b,0)/v.length
        ),
        type: 'bar'
    }], {
        xaxis: { title: 'Кількість потоків' },
        yaxis: { title: 'CPU %' }
    });
}
</script>
{% endblock %}
