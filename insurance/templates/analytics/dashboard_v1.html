{% extends "base.html" %}
{% block title %}Analytics v1 (Plotly){% endblock %}
{% block content %}
<h1>Analytics v1 (Plotly)</h1>

<div style="margin:10px 0; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
  <label>From: <input type="date" id="f_date_from"></label>
  <label>To: <input type="date" id="f_date_to"></label>
  <label>Policy type: <input type="text" id="f_policy_type" placeholder="e.g. Health"></label>
  <label>Top N: <input type="number" id="f_top_n" value="10" min="1" style="width:80px"></label>
  <label>Threshold: <input type="number" id="f_threshold" value="0" step="0.01" style="width:120px"></label>
  <button id="btn_apply">Apply</button>
  <button id="btn_reset">Reset</button>
  <span id="meta_info"></span>
  
</div>

<div id="charts" style="display:grid; grid-template-columns: 1fr 1fr; gap:18px;">
  <div id="c1"></div>
  <div id="c2"></div>
  <div id="c3"></div>
  <div id="c4"></div>
  <div id="c5"></div>
  <div id="c6"></div>
</div>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script>
const q = sel => document.querySelector(sel);
function params() {
  return {
    date_from: q('#f_date_from').value || '',
    date_to: q('#f_date_to').value || '',
    policy_type: q('#f_policy_type').value || '',
    limit: q('#f_top_n').value || 10,
    threshold: q('#f_threshold').value || 0
  };
}
function buildUrl(path, extra={}){
  const p = {...params(), ...extra};
  const sp = new URLSearchParams();
  Object.entries(p).forEach(([k,v])=>{ if(v!=='' && v!=null) sp.set(k,v); });
  return `/api/analytics/${path}?${sp.toString()}`;
}

async function fetchJson(url){
  const r = await fetch(url);
  return r.json();
}

async function render(){
  const p = params();
  q('#meta_info').textContent = '';
  // 1) Payments by month (bar)
  const d1 = await fetchJson(buildUrl('payments-by-month'));
  const x1 = d1.data.map(r=>r.month + ' / ' + r.ptype);
  const y1 = d1.data.map(r=>Number(r.total_amount));
  Plotly.newPlot('c1', [{type:'bar', x:x1, y:y1}], {title:'Payments by month and policy type'});

  // 2) Avg claim by age group (bar)
  const d2 = await fetchJson(buildUrl('avg-claim-by-age-group'));
  const x2 = d2.data.map(r=>r.age_group);
  const y2 = d2.data.map(r=>Number(r.avg_amount));
  Plotly.newPlot('c2', [{type:'bar', x:x2, y:y2}], {title:'Average claim amount by age group'});

  // 3) Claims per customer (histogram)
  const d3 = await fetchJson(buildUrl('claims-per-customer'));
  const y3 = d3.data.map(r=>Number(r.claims_count || 0));
  Plotly.newPlot('c3', [{type:'histogram', x:y3}], {title:'Claims per customer distribution'});

  // 4) Policy profit by type (pie)
  const d4 = await fetchJson(buildUrl('policy-profit-by-type'));
  const labels4 = d4.data.map(r=>r.policy_type);
  const values4 = d4.data.map(r=>Number(r.profit));
  Plotly.newPlot('c4', [{type:'pie', labels:labels4, values:values4}], {title:'Policy profit by type'});

  // 5) Time to claim (line)
  const d5 = await fetchJson(buildUrl('time-to-claim'));
  const byType = {};
  for(const r of d5.data){
    (byType[r.policy_type] ||= []).push(Number(r.days));
  }
  const traces5 = Object.entries(byType).map(([k,v])=>({type:'box', name:k, y:v}));
  Plotly.newPlot('c5', traces5, {title:'Time to first claim (days) per policy type'});

  // 6) Top customers by payouts (bar)
  const d6 = await fetchJson(buildUrl('top-customers-by-payouts'));
  Plotly.newPlot('c6', [{type:'bar', x:d6.data.map(r=>r.full_name), y:d6.data.map(r=>Number(r.total_payout))}], {title:'Top customers by payouts'});

  q('#meta_info').textContent = `Loaded: ${[d1,d2,d3,d4,d5,d6].map(x=>x.meta?.rows||0).reduce((a,b)=>a+b,0)} rows`;
}

q('#btn_apply').addEventListener('click', render);
q('#btn_reset').addEventListener('click', ()=>{
  ['#f_date_from','#f_date_to','#f_policy_type'].forEach(s=> q(s).value='');
  q('#f_top_n').value=10; q('#f_threshold').value=0;
  render();
});

render();
</script>
{% endblock %}
